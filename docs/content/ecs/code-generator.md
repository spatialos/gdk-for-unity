**Warning:** The [alpha](https://docs.improbable.io/reference/latest/shared/release-policy#maturity-stages) release is for evaluation purposes only, with limited documentation - see the guidance on [Recommended use](../../../README.md#recommended-use).

-----


## ECS: The code generator

The SpatialOS GDK for Unity comes packaged with a custom code generator. This doc will detail how the code generator works on a high level and describe how to make changes to it. The source code for the code generator can be found in the [code_generator](../../../workers/unity/Packages/com.improbable.gdk.tools/.CodeGenerator) directory in the root of the repository and is written in C#.

### High-level breakdown

#### JSON AST parsing

The code generator operates on the [JSON AST](https://docs.improbable.io/reference/latest/shared/schema/custom-codegen#abstract-syntax-tree-format) that is generated by the schema compiler. A pre-built `dll` parses this JSON AST and converts it to C# objects.

The parsing stage, shown in the code snippet below, is in [CodeGenerator.cs](../../../workers/unity/Packages/com.improbable.gdk.tools/.CodeGenerator/GdkCodeGenerator/src/CodeGenerator.cs):

```csharp
    var schemaFilesRaw = SchemaFiles.GetSchemaFilesRaw(options.JsonDirectory, fileSystem).ToList();
    var schemaProcessor = new UnitySchemaProcessor(schemaFilesRaw);
```

The code generator then does post-processing on the collection of C# objects that represent the schema.

1. It flags each type and component as [blittable or not blittable](https://docs.microsoft.com/en-us/dotnet/framework/interop/blittable-and-non-blittable-types). This information is required as blittable and non-blittable components need to be generated in a different manner. You can find the source for this in [BlittableFlagger.cs](../../../workers/unity/Packages/com.improbable.gdk.tools/.CodeGenerator/GdkCodeGenerator/src/Generation/SchemaProcessing/BlittableFlagger.cs).
2. It marks data types that are used as event, command request, and/or command response payloads. You can find the source for this in [PayloadMarker.cs](../../../workers/unity/Packages/com.improbable.gdk.tools/.CodeGenerator/GdkCodeGenerator/src/Generation/SchemaProcessing/PayloadMarker.cs).

#### T4 templates

The code generation is done with [T4 templates](https://msdn.microsoft.com/en-us/library/bb126445.aspx). All the templates used in code generation are located in [the Templates directory](../../../workers/unity/Packages/com.improbable.gdk.tools/.CodeGenerator/GdkCodeGenerator/Templates/).

Note: the transformation of T4 to C# is in a pre-build step which is defined in [GdkCodeGenerator.csproj](../../../workers/unity/Packages/com.improbable.gdk.tools/.CodeGenerator/GDKCodeGenerator/GdkCodeGenerator.csproj). The relevant section is reproduced below:

```xml
  <ItemGroup>
    <T4Files Include="Templates\UnityCommandPayloadGenerator.tt" />
    <T4Files Include="Templates\UnityComponentConversionGenerator.tt" />
    <T4Files Include="Templates\UnityComponentDataGenerator.tt" />
    <T4Files Include="Templates\UnityComponentGenerator.tt" />
    <T4Files Include="Templates\UnityEnumGenerator.tt" />
    <T4Files Include="Templates\UnityEnumContent.tt" />
    <T4Files Include="Templates\UnityEventGenerator.tt" />
    <T4Files Include="Templates\UnityTypeGenerator.tt" />
    <T4Files Include="Templates\UnityTypeContent.tt" />
  </ItemGroup>

  <UsingTask TaskName="Improbable.TextTemplating.TransformAllTask" AssemblyFile="dependencies/Improbable.TextTemplating/Improbable.TextTemplating.dll" />

  <Target Name="Code Template Generation" BeforeTargets="BeforeBuild">
    <TransformAllTask InputFiles="@(T4Files)" ProjectDirectory="$(MSBuildProjectDirectory)" Imports="Improbable.CodeGeneration.Jobs" ClassNameSpace="Improbable.Gdk.CodeGenerator">
      <Output TaskParameter="OutputFiles" PropertyName="GeneratedFiles" />
    </TransformAllTask>
    <ItemGroup>
      <Compile Include="$(GeneratedFiles)" />
    </ItemGroup>
  </Target>
  ```

Each T4 template is paired with a hand-written partial class that defines the data used in the template. These partial classes can be found [here](../../../workers/unity/Packages/com.improbable.gdk.tools/.CodeGenerator/GDKCodeGenerator/src/Generation/Generators/Parts/).


#### Code generation jobs

After post processing, a code generation job is run on each C# object that represents a single schema file. This job is defined in [SingleGenerationJob.cs](../../../workers/unity/Packages/com.improbable.gdk.tools/.CodeGenerator/GDKCodeGenerator/src/Generation/SingleGenerationJob.cs). This job enumerates all the enums, types, and components in a single schema file and runs the correct generator for each.


### Editing the code generator

The process of editing the code generator is simple:

1. Make the code and/or template changes.
2. Reload scripts within Unity to see your changes in action! The code generator will automatically be rebuilt.


#### Spatial Codegen configuration

If any changes you make change the input parameters or add new ones, you should add them to `Packages/com.improbable.gdk.tools/GenerateCode.cs` so it runs correctly!

----
**Give us feedback:** We want your feedback on the SpatialOS GDK for Unity and its documentation  - see [How to give us feedback](../../../README.md#give-us-feedback).
