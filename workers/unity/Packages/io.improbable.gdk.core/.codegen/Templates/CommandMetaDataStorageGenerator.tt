<#@ template language="C#" #>
<#@ output extension=".cs" #>
<#
    var componentDetails = GetComponentDetails();
    var generatedHeader = CommonGeneratorUtils.GetGeneratedHeader();
    var commandDetailsList = GetCommandDetailsList();
#>
<#= generatedHeader #>

using System.Collections.Generic;
using Improbable.Gdk.Core;

namespace <#= qualifiedNamespace #>
{
    public partial class <#= componentDetails.ComponentName #>
    {
<# foreach (var command in commandDetailsList) {
        var receivedRequestType = command.CommandName + ".ReceivedRequest";
        var receivedResponseType = command.CommandName + ".RawReceivedResponse";
#>
<#
    logger.Trace($"Generating {command.CommandName}CommandMetaDataStorage class");
#>
        public class <#= command.CommandName #>CommandMetaDataStorage : ICommandMetaDataStorage, ICommandPayloadStorage<<#= command.FqnRequestType #>>
        {
            private readonly Dictionary<long, CommandContext<<#= command.FqnRequestType #>>> requestIdToRequest =
                new Dictionary<long, CommandContext<<#= command.FqnRequestType #>>>();

            private readonly Dictionary<long, long> internalRequestIdToRequestId = new Dictionary<long, long>();

            public uint GetComponentId()
            {
                return ComponentId;
            }

            public uint GetCommandId()
            {
                return <#= command.CommandIndex #>;
            }

            public void RemoveMetaData(long internalRequestId)
            {
                var requestId = internalRequestIdToRequestId[internalRequestId];
                internalRequestIdToRequestId.Remove(internalRequestId);
                requestIdToRequest.Remove(requestId);
            }

            public void SetInternalRequestId(long internalRequestId, long requestId)
            {
                internalRequestIdToRequestId.Add(internalRequestId, requestId);
            }

            public void AddRequest(in CommandContext<<#= command.FqnRequestType #>> context)
            {
                requestIdToRequest[context.RequestId] = context;
            }

            public CommandContext<<#= command.FqnRequestType #>> GetPayload(long internalRequestId)
            {
                var id = internalRequestIdToRequestId[internalRequestId];
                return requestIdToRequest[id];
            }
        }

<# } #>
    }
}
